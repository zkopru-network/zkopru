version: 2.1
workflows:
  test_app:
    jobs:
      - build
      - load_keys:
          requires:
            - build
      - test_integration:
          requires:
            - load_keys

jobs:
  build:
    machine:
      image: ubuntu-2004:202010-01
    steps:
      - checkout
      - run:
          name: Install Yarn
          command: curl -o- -L https://yarnpkg.com/install.sh | bash
      - run:
          name: Install
          command: yarn
      - run:
          name: Build Contract
          command: yarn build:contract
      - run:
          name: Build TS
          command: yarn build:ts:serial
      - persist_to_workspace:
          root: ~/
          paths: project
  load_keys:
    machine:
      image: ubuntu-2004:202010-01
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Load Keys
          command: |
            cd packages/circuits
            yarn download-keys
      - persist_to_workspace:
          root: ~/
          paths: project
  test_integration:
    machine:
      image: ubuntu-2004:202010-01
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Build Testnet
          command: docker-compose -f compose/docker-compose.yml build contracts-for-integration-test
      - run:
          name: Integration Tests
          command: DEBUG=1 yarn test --scope=@zkopru/integration-test
